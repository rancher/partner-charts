suite: test security context configuration
templates:
  - templates/deployment.yaml
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: should use default pod security context when no values are set
    set:
      cluster: test-cluster
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should apply component-level podSecurityContext
    set:
      cluster: test-cluster
      podSecurityContext:
        fsGroup: 3000
        runAsUser: 4000
        runAsGroup: 4000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 3000
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 4000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 4000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault

  - it: should apply global podSecurityContext
    set:
      cluster: test-cluster
      global:
        podSecurityContext:
          fsGroup: 5000
          runAsUser: 6000
          runAsGroup: 6000
          runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 5000
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 6000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 6000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: component-level podSecurityContext should override global
    set:
      cluster: test-cluster
      global:
        podSecurityContext:
          fsGroup: 5000
          runAsUser: 6000
      podSecurityContext:
        fsGroup: 7000
        runAsUser: 8000
        runAsGroup: 8000
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 7000
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 8000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 8000

  - it: should fall back to defaults when empty podSecurityContext is set
    set:
      cluster: test-cluster
      global:
        podSecurityContext: {}
      podSecurityContext: {}
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 2000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should apply component-level containerSecurityContext
    set:
      cluster: test-cluster
      containerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should apply global containerSecurityContext
    set:
      cluster: test-cluster
      global:
        containerSecurityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - NET_RAW
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: NET_RAW

  - it: component-level containerSecurityContext should override global
    set:
      cluster: test-cluster
      global:
        containerSecurityContext:
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false
      containerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsUser: 9000
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 9000

  - it: should handle empty containerSecurityContext (no container security context)
    set:
      cluster: test-cluster
      containerSecurityContext: {}
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].securityContext

  - it: should apply both pod and container security contexts together
    set:
      cluster: test-cluster
      podSecurityContext:
        fsGroup: 10000
        runAsUser: 11000
        runAsGroup: 11000
        runAsNonRoot: true
      containerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
    asserts:
      # Pod-level security context
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 10000
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 11000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 11000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      # Container-level security context
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL

  - it: should apply comprehensive security hardening configuration
    set:
      cluster: test-cluster
      podSecurityContext:
        fsGroup: 65534
        runAsUser: 65534
        runAsGroup: 65534
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containerSecurityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65534
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
    asserts:
      # Pod-level assertions
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 65534
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 65534
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 65534
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.seccompProfile.type
          value: RuntimeDefault
      # Container-level assertions
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 65534
      - contains:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop
          content: ALL
      - equal:
          path: spec.template.spec.containers[0].securityContext.seccompProfile.type
          value: RuntimeDefault
