{{- $releaseNamespace := .Release.Namespace }}
{{- $usePC := .Values.ntnxInitConfigMap.usePC }}
{{- $csiDriverName := include "nutanix-csi-storage.drivername" . }}
{{- $ntnxVolumes := "NutanixVolumes" }}
{{- $usePETopology := include "isPETopologyEnabled" . }}
{{- $createPESecrets := .Values.createPESecrets }}

{{- $isChartRenderedInCluster := include "nutanix-csi-storage.isChartRenderedInCluster" . }}

# Validation: When usePC is false and usePETopology is enabled, peSecrets must not be empty
{{- if and (eq $usePC false) (eq $usePETopology "true") }}
  {{- if eq (len .Values.peSecrets) 0 }}
    {{- fail "peSecrets list cannot be empty when usePC is false and usePETopology is enabled. Please configure at least one PE secret in peSecrets (either for Helm to create secrets or to reference existing user-defined secrets)." }}
  {{- end }}
{{- end }}

{{- $peHostDict := dict }}

# CSI managed PE secrets
{{- if eq $createPESecrets true }}
{{- range $index, $peSecret := .Values.peSecrets }}
  {{- $prismEndPoint := required (printf "peSecrets[%d].prismEndPoint is required" $index) $peSecret.prismEndPoint }}
  {{- $username := required (printf "peSecrets[%d].username is required" $index) $peSecret.username }}
  {{- $password := required (printf "peSecrets[%d].password is required" $index) $peSecret.password }}
  {{- $secretName := default (printf "pe-secret-%d" $index) $peSecret.secretName }}
  {{- $_ := set $peHostDict $prismEndPoint true }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "nutanix-csi-storage.labels" $ | nindent 4 }}
  annotations:
    nutanix.com/csi-auth-schema-version: "v1"
stringData:
  key: {{ printf "%s:9440:%s:%s" $prismEndPoint $username $password | quote }}
{{- end }}  
{{- end }}  

{{- if eq $createPESecrets false }}
{{- range $index, $peSecret := .Values.peSecrets }}
  {{- $secretName := required (printf "peSecrets[%d].secretName is required" $index) $peSecret.secretName }}
{{- if eq $isChartRenderedInCluster "true" }}
# Check if all user-defined secrets are already present in the cluster; otherwise, mounting the secret to the pod will fail.
  {{- $peSecret := lookup "v1" "Secret" $releaseNamespace $secretName }}
  {{- if not $peSecret }}
    {{- fail (printf "User defined PE secret '%s' not present in '%s' namespace in the cluster. Please create the secret before installing or upgrading the chart." $secretName $releaseNamespace) }}
  {{- else }}
    {{- $peSecretValue := "" }}
    {{- range $peSecretKey, $peSecretDataEncoded := $peSecret.data }}
      {{- if eq $peSecretKey "key" }}
        {{- $peSecretValue = ($peSecretDataEncoded | b64dec | trim) }}
      {{- end }}
    {{- end }}
    {{- if ne $peSecretValue "" }}
      {{- $parts := split ":" $peSecretValue }}
      {{- if not (eq (len $parts) 4) }}
        {{- fail (printf "Invalid user defined PE secret '%s' in namespace '%s'. Invalid value in secret field 'key'." $secretName $releaseNamespace) }}
      {{- end }}
      {{- $host := $parts._0 -}}
      {{- if eq $host "" }}
        {{- fail (printf "Invalid user defined PE secret '%s' in '%s' namespace. Missing host value in the secret." $secretName $releaseNamespace) }}
      {{- else }}
        {{- $_ := set $peHostDict $host true }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}


{{- if and (eq $usePC false) (eq $usePETopology "true") (eq $isChartRenderedInCluster "true") }}

# Iterate over all StorageClasses to fetch the old PE secrets referenced in secretRefs
{{- $storageClasses := lookup "storage.k8s.io/v1" "StorageClass" "" "" -}}
{{- $peSecrets := dict }}
{{- $scSecretRefs := list "provisioner" "controller-publish" "node-publish" "controller-expand" }}
{{- if and $storageClasses $storageClasses.items }}
{{- range $sc := $storageClasses.items }} 
  {{- if eq $sc.provisioner $csiDriverName }}
    {{- $isNutanixVolume := false }}
    {{- range $key, $value := $sc.parameters }}
      {{- if and (eq (lower $key) "storagetype") (eq $value $ntnxVolumes)}}
        {{- $isNutanixVolume = true }}
      {{- end }}
    {{- end }}
    {{- if $isNutanixVolume }}
      {{- range $secretRef := $scSecretRefs }}
        {{- $secretNameKey := (printf "csi.storage.k8s.io/%s-secret-name" $secretRef) }}
        {{- $secretNamespaceKey := (printf "csi.storage.k8s.io/%s-secret-namespace" $secretRef) }}
        # Not failing if the StorageClass does not have secretRefs
        {{- if and (hasKey $sc.parameters $secretNameKey) (hasKey $sc.parameters $secretNamespaceKey) }}
          {{- $secretName := index $sc.parameters $secretNameKey }}
          {{- $secretNamespace := index $sc.parameters $secretNamespaceKey }}
          {{- $key := (printf "%s:%s" $secretName $secretNamespace) }}
          {{- if not (hasKey $peSecrets $key) }}
            {{- $_ := set $peSecrets $key true }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{- $missingPEDict := dict }}

# Iterate over all PE secrets to find the all the corresponding PE hosts
{{- range $key := keys $peSecrets }}
  {{- $parts := split ":" $key }}
  {{- $secretName := $parts._0 }}
  {{- $secretNamespace := $parts._1 }}
  {{- $peSecret := lookup "v1" "Secret" $secretNamespace $secretName }}
  {{- if $peSecret }}
    {{- $peSecretValue := "" }}
    {{- range $peSecretKey, $peSecretDataEncoded := $peSecret.data }}
      {{- if eq $peSecretKey "key" }}
        {{- $peSecretValue = ($peSecretDataEncoded | b64dec | trim) }}
      {{- end }}
    {{- end }}
    {{- if ne $peSecretValue "" }}
      {{- $parts := split ":" $peSecretValue }}
      {{- if not (eq (len $parts) 4) }}
        {{- fail (printf "Invalid user defined PE secret '%s' in namespace '%s'. Invalid value in secret field 'key'." $secretName $releaseNamespace) }}
      {{- end }}
      {{- $host := $parts._0 -}}
      {{- if eq $host "" }}
        {{- fail (printf "Invalid user defined PE secret '%s' in '%s' namespace. Missing host value in the secret." $secretName $releaseNamespace) }}
      {{- else }}
        # Check if the old PE secrets in the cluster are defined under peSecrets in Helm values
        {{- if not (hasKey $peHostDict $host) }}
          {{- $_ := set $missingPEDict $host true }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- if gt (len $missingPEDict) 0 }}
  {{- $missingPEs := (keys $missingPEDict | join ", ") }}
  {{- fail (printf "Secrets for the following PE Endpoints (%s) are present in the cluster but not listed under peSecrets in values.yaml." $missingPEs) }}
{{- end }}

{{- end }}