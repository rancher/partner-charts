{{ include "check.validatePrometheusConfig" .}}
{{- if .Values.prometheus.server.enabled -}}
{{- $cluster_domain := "" -}}
{{- with .Values.cluster.domainName -}}
  {{- $cluster_domain = printf ".%s" . -}}
{{- end -}}
{{- $rbac := .Values.prometheus.rbac.create -}}
{{- /* Require clusterName when remote_write is enabled */ -}}
{{- if .Values.prometheus.server.remote_write -}}
  {{- $_ := required "clusterName is required when prometheus.server.remote_write is configured" .Values.clusterName -}}
{{- end -}}
{{- /* Try to auto-detect cluster UUID from default namespace */ -}}
{{- $clusterUID := "" -}}
{{- if .Values.prometheus.server.clusterUIDOverride -}}
  {{- $clusterUID = .Values.prometheus.server.clusterUIDOverride -}}
{{- else -}}
  {{- $defaultNS := (lookup "v1" "Namespace" "" "default") -}}
  {{- if $defaultNS -}}
    {{- $clusterUID = $defaultNS.metadata.uid -}}
  {{- end -}}
{{- end -}}
kind: ConfigMap
apiVersion: v1
metadata:
  labels:
{{ include "helm.labels" . | indent 4 }}
  namespace: {{ .Release.Namespace }}
  name: {{ .Release.Name }}-{{ .Values.prometheus.server.configMapOverrideName }}
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ (default "1m" .Values.prometheus.server.global.scrape_interval) | quote }}
      scrape_timeout: {{ (default "10s" .Values.prometheus.server.global.scrape_timeout) | quote }}
      evaluation_interval: {{ (default "1m" .Values.prometheus.server.global.evaluation_interval) | quote }}
{{- if or .Values.clusterName $clusterUID .Values.prometheus.server.global.external_labels }}
      external_labels:
{{- if $clusterUID }}
        cluster_uid: {{ $clusterUID }}
{{- end }}
{{- if .Values.clusterName }}
        cluster_name: {{ .Values.clusterName }}
{{- end }}
{{- if .Values.prometheus.server.global.external_labels }}
{{- toYaml .Values.prometheus.server.global.external_labels | nindent 8 }}
{{- end }}
{{- end }}
{{- if .Values.prometheus.server.remote_write }}
    remote_write:
{{- toYaml .Values.prometheus.server.remote_write | nindent 6 }}
{{- end }}
    scrape_configs:
      - job_name: httpServiceDiscovery
        http_sd_configs:
          - url: {{ printf "http://metering-svc.%s.svc%s:8000/v0/listScrapeTargets" .Release.Namespace $cluster_domain }}
{{- if or .Values.workerPodMetricSidecar.enabled .Values.kanisterPodMetricSidecar.enabled }}
      - job_name: pushAggregator
        honor_timestamps: true
        metrics_path: /v0/push-metric-agg/metrics
        static_configs:
          - targets:
              - {{ printf "metering-svc.%s.svc%s:8000" .Release.Namespace $cluster_domain }}
{{- end -}}
{{- if .Values.prometheus.scrapeCAdvisor }}
      - job_name: 'kubernetes-cadvisor'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        kubernetes_sd_configs:
        - role: node
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
{{- end}}
      - job_name: prometheus
        metrics_path: {{ .Values.prometheus.server.baseURL }}metrics
        static_configs:
          - targets:
              - "localhost:9090"
            labels:
              app: prometheus
              component: server
      - job_name: k10-pods
        scheme: http
        metrics_path: /metrics
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              own_namespace: true
            selectors:
              - role: pod
                label: "component=executor"
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: 8\d{3}
{{- end -}}
